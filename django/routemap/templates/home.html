{% extends "splunkdj:base_with_account_bar.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} Home Page{% endblock title %}

{% block css %}
    <link rel="stylesheet" href="{{STATIC_URL}}{{app_name}}/custom.css" >
{% endblock css %}

{% block content %}
    <div>
        <div id="searchPanel">
        </div>
        <div id="routes-map-view">
            <div>
                <form class="form-inline">
                    <button id="button-play" type="button" class="btn">Play</button>
                    <button id="button-pause" type="button" class="btn">Pause</button>
                    <button id="button-autozoom" type="button" class="btn">Auto zoom</button>
                    <label for="input-speed-value">Speed</label>
                    <input id="input-speed-value" type="range" min="0.1" max="300" class="input"/>
                    <span class="help-block"><span id="span-speed-value" class="min-width-30 text-right">1</span>X</span>
                    <label for="input-graduality-value">Graduality</label>
                    <input id="input-graduality-value" type="range" min="1" max="20" class="input"/>
                    <span class="help-block"><span id="span-graduality-value" class="min-width-30 text-right"></span> times per seconds</span>
                </form>
            </div>
            <div><input id="input-time" type="range" /></div>
            <div id="bar-time-ranges" class="row-fluid">
                <div class="span2 text-left"><span><!--Begin time--></span></div>
                <div class="span8 text-center"><span><!--Current time--></span></div>
                <div class="span2 text-right"><span><!--End time--></span></div>
            </div>
            <div class="row-fluid">
                <div class="span3">

                    <div id="map-objects-header">
                        <h3>Objects on the map</h3>
                        <div class="form-inline">
                            <label class="checkbox inline" >
                                <input type="checkbox" checked="true" /> All objects
                            </label>
                            <label class="checkbox inline" >
                                <input type="checkbox" /> <span>All routes</span>
                            </label>
                        </div>
                        
                    </div>

                    <script type="text/template" id="map-object-list-template">
                        <div>
                            <label><%- title %></label>
                            <div class="form-inline">
                                <small>Show: </small>
                                <label class="checkbox" >
                                    <input type="checkbox" <%= showObject ? 'checked="checked"' : '' %> /> <small>Object</small>
                                </label>
                                <label class="checkbox" >
                                    <input type="checkbox" <%= showRoute ? 'checked="checked"' : '' %> /> <small>Route</small>
                                </label>
                            </div>
                        </div>
                    </script>

                    <ul id="map-objects-list" class="unstyled"></ul>
                    
                </div>
                <div class="span9" id="map-wrapper">
                    <div id="map">
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content%}

{% block js %}
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="{{STATIC_URL}}{{app_name}}/mapObjectsDictionary.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}{{app_name}}/mapObjectsViewModel.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}{{app_name}}/routesMapView.js"></script>
    <!-- https://github.com/hpneo/gmaps -->
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/gmaps.js/0.4.5/gmaps.min.js"></script>
    <script>
        var deps = [
            'splunkjs/ready!',
            'splunkjs/mvc/searchbarview',
            'splunkjs/mvc/searchcontrolsview',
            'splunkjs/mvc/tableview',
            'splunkjs/mvc/searchmanager',
            'underscore',
            'routesMapView'
        ];
        require(deps, function(mvc) {
            var SearchbarView = require('splunkjs/mvc/searchbarview');
            var SearchControlsView = require('splunkjs/mvc/searchcontrolsview');
            var TableView = require('splunkjs/mvc/tableview');
            var SearchManager = require('splunkjs/mvc/searchmanager');
            var _ = require('underscore');
            var travelSystemModule = require('routesMapView');

            // Initialize new search manager

            var searchManager = new SearchManager({
                id: 'appSearchManager',
                app: 'routemap',
                preview: true,
                required_field_list: '*',
                status_buckets: 300,
                search: 'source=firebase | `normalize(ts=ts, lat=lat, lon=lon, field1=routeTag, field2=id)`'
            });

            var searchPanel = $('#searchPanel');

            // Instantiate the views and search manager
            var searchbarView = new SearchbarView({
                managerid: searchManager.id,
                el: searchPanel.append('div')
            }).render();

            // Update the search manager when the query in the searchbar changes
            searchbarView.on('change', function() {
                searchManager.set('search', searchbarView.val());
            });

            // Update the search manager when the timerange in the searchbar changes
            searchbarView.timerange.on('change', function() {
                searchManager.search.set(searchbarView.timerange.val());
            });

            new SearchControlsView({
                managerid: searchManager.id,
                el: searchPanel.append('div')
            }).render();

            var travelSystem = new travelSystemModule();

            // Connect to search
            var routesData = searchManager.data('results', {count: 0, output_mode: 'json'});
            routesData.on('data', function() {
                console.log('got new data');

                if (!routesData.hasData()) {
                    return;
                }

                if (travelSystem) {
                    travelSystem.viewModel.pause();
                    travelSystem.viewModel.removeAllObjects();
                } 

                var bounds = new google.maps.LatLngBounds();
                
                var results = routesData.data().results;
                for (var rIndex = 0; rIndex < results.length; rIndex++) {
                    var result = results[rIndex];

                    if (result.data) {
                        var data = result.data.split(';');
                        var point = { ts: parseFloat(data[0]), lat: parseFloat(data[1]), lon: parseFloat(data[2]) };
                        delete result['data'];
                        travelSystem.viewModel.addData(result, point);
                    }
                }
                
                travelSystem.viewModel.autoZoom();
                travelSystem.viewModel.play();
            });
        });
    </script>
{% endblock js %}